dataSources:
  vmId:
    type: "gce-metadata"
    value: "instance/id"
  vmZone:
    type: "gce-metadata"
    value: "instance/zone"
  vmProjectId:
    type: "gce-metadata"
    value: "project/project-id"
  totalRequests:
    type: "random"
    value: "float"
    range: "95.0 ~ 105.0"
  failedRequestsOk:
    type: "random"
    value: "float"
    range: "0.0 ~ 45.0"
  failedRequestsKo:
    type: "random"
    value: "float"
    range: "76.0 ~ 99.0"
  resourceUsageOk:
    type: "random"
    value: "float"
    range: "45.0 ~ 69.0"
  resourceUsageKo:
    type: "random"
    value: "float"
    range: "85.0 ~ 99.0"

metricDescriptors:
  - name: "db_recover_sys"
    type: "advobv/db/recover_sys"
    metricKind: "GAUGE"
    valueType: "DOUBLE"
    description: "The heartbeat checker for the database."
    displayName: "Database Recovery System"
    launchStage: "GA"
    monitoredResourceTypes:
      - "gce_instance"
  - name: "db_resource_load"
    type: "advobv/db/resource_load"
    metricKind: "GAUGE"
    valueType: "DOUBLE"
    unit: "%"
    description: "The resource load on the database engine."
    displayName: "Database Resource Load"
    launchStage: "GA"
    monitoredResourceTypes:
      - "gce_instance"
  - name: "db_requests_failed"
    type: "advobv/db/requests_failed"
    metricKind: "GAUGE"
    valueType: "DOUBLE"
    description: "Database requests failed."
    displayName: "Database Failed Requests"
    launchStage: "GA"
    monitoredResourceTypes:
      - "gce_instance"
  - name: "db_requests_total"
    type: "advobv/db/requests_total"
    metricKind: "GAUGE"
    valueType: "DOUBLE"
    description: "Database total requests."
    displayName: "Database Total Requests"
    launchStage: "GA"
    monitoredResourceTypes:
      - "gce_instance"

monitoringJobs:
  - live: true
    frequency: "5s"
    resourceType: "gce_instance"
    resourceLabels:
      project_id: "{vmProjectId}"
      instance_id: "{vmId}"
      zone: "{vmZone}"
    projectId: "{vmProjectId}"
    variables:
      - "vmId"
      - "vmZone"
      - "vmProjectId"
      - "totalRequests"
    metricEntries:
    # First two minutes all is ok
      - endOffset: "2m"
        metricType: "advobv/db/requests_failed"
        metricValue: "{failedRequestsOk}"
        variables:
          - "failedRequestsOk"
      - endOffset: "2m"
        metricType: "advobv/db/requests_total"
        metricValue: "{totalRequests}"
      - endOffset: "2m"
        metricType: "advobv/db/recover_sys"
        metricValue: "1"
      - endOffset: "2m"
        metricType: "advobv/db/resource_load"
        metricValue: "{resourceUsageOk}"
        variables:
          - "resourceUsageOk"
    # Then sh*t hits the fan
      - startOffset: "2m5s"
        endOffset: "5m5s"
        metricType: "advobv/db/requests_failed"
        metricValue: "{failedRequestsKo}"
        variables:
          - "failedRequestsKo"
      - startOffset: "2m5s"
        endOffset: "5m5s"
        metricType: "advobv/db/requests_total"
        metricValue: "{totalRequests}"
      # absence of metric "advobv/db/recover_sys"
      - startOffset: "2m5s"
        endOffset: "5m5s"
        metricType: "advobv/db/resource_load"
        metricValue: "{resourceUsageKo}"
        variables:
          - "resourceUsageKo"
    # After three minutes all is ok again
      - startOffset: "5m10s"
        endOffset: "10m10s"
        metricType: "advobv/db/requests_failed"
        metricValue: "{failedRequestsOk}"
        variables:
          - "failedRequestsOk"
      - startOffset: "5m10s"
        endOffset: "10m10s"
        metricType: "advobv/db/requests_total"
        metricValue: "{totalRequests}"
      - startOffset: "5m10s"
        endOffset: "10m10s"
        metricType: "advobv/db/recover_sys"
        metricValue: "1"
      - startOffset: "5m10s"
        endOffset: "10m10s"
        metricType: "advobv/db/resource_load"
        metricValue: "{resourceUsageOk}"
        variables:
          - "resourceUsageOk"
